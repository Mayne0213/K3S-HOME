apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # 2 replicas (mayne-worker-1 has issues)
    deployment:
      replicas: 2

    # Pod Anti-Affinity - 각 노드에 최대 1개씩만 배치
    # Node Affinity - mayne-worker-1 제외 (Traefik API 문제)
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: NotIn
                  values:
                    - mayne-worker-1
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/name: traefik
            topologyKey: kubernetes.io/hostname

    # Master 노드에도 배치 허용
    tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
      - key: node-role.kubernetes.io/control-plane
        operator: Exists

    # Traefik Dashboard 활성화
    dashboard:
      enabled: true

    # API 활성화 (Dashboard에서 필요)
    api:
      dashboard: true
      insecure: false

    # ports 설정
    ports:
      traefik:
        expose:
          default: true

    # svclb tolerations for master node
    service:
      annotations:
        svccontroller.k3s.cattle.io/tolerations: '[{"key":"node-role.kubernetes.io/master","operator":"Exists","effect":"NoExecute"}]'
